#!/usr/bin/env node

/**
 * IP ID Generation Test Script
 * Tests the IP ID generation in both success and fallback modes
 */

const fetch = require('node-fetch');

const BASE_URL = 'http://localhost:3000';
const TEST_USER_ADDRESS = '0x3b31d87804c345a7d39f0267d0d4ff1dcc9b1433';

// Test data
const testDanceData = {
  userAddress: TEST_USER_ADDRESS,
  title: 'IP ID Test Dance',
  description: 'Testing IP ID generation for Story Protocol',
  danceStyle: 'Test Style',
  choreographer: 'IP Tester',
  duration: '1:30',
  analysisResults: {
    totalMoves: 15,
    uniqueSequences: 5,
    confidenceScore: 90,
    complexity: 'Simple'
  }
};

function validateIpId(ipId, description) {
  console.log(`\nğŸ” [IP-ID-TEST] Validating ${description}:`);
  console.log(`ğŸ“‹ [IP-ID-TEST] IP ID: ${ipId}`);
  
  if (!ipId) {
    console.error(`âŒ [IP-ID-TEST] No IP ID provided`);
    return false;
  }
  
  // Check if it's a proper hex string
  if (ipId.startsWith('0x')) {
    console.log(`âœ… [IP-ID-TEST] Proper hex format`);
    
    // Check length (should be 0x + 40 characters for address + 24 characters for token ID = 66 total)
    if (ipId.length === 66) {
      console.log(`âœ… [IP-ID-TEST] Correct length (66 characters)`);
      
      // Extract contract address and token ID
      const contractPart = '0x' + ipId.slice(2, 42);
      const tokenIdPart = ipId.slice(42);
      
      console.log(`ğŸ“‹ [IP-ID-TEST] Contract address: ${contractPart}`);
      console.log(`ğŸ“‹ [IP-ID-TEST] Token ID (hex): ${tokenIdPart}`);
      console.log(`ğŸ“‹ [IP-ID-TEST] Token ID (decimal): ${parseInt(tokenIdPart, 16)}`);
      
      // Validate contract address format
      if (contractPart.match(/^0x[a-fA-F0-9]{40}$/)) {
        console.log(`âœ… [IP-ID-TEST] Valid contract address format`);
        return true;
      } else {
        console.error(`âŒ [IP-ID-TEST] Invalid contract address format`);
        return false;
      }
    } else {
      console.error(`âŒ [IP-ID-TEST] Incorrect length: ${ipId.length} (expected 66)`);
      return false;
    }
  } else {
    console.log(`âš ï¸ [IP-ID-TEST] Legacy reference format (not hex)`);
    return true; // Legacy format is acceptable for fallback
  }
}

async function testPrepareMintIpId() {
  console.log('\nğŸš€ [IP-ID-TEST] Testing prepare-mint IP ID generation...');
  
  try {
    const response = await fetch(`${BASE_URL}/api/prepare-mint`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(testDanceData),
    });
    
    const result = await response.json();
    
    if (!response.ok || !result.success) {
      throw new Error(`Prepare-mint failed: ${JSON.stringify(result.error)}`);
    }
    
    console.log('âœ… [IP-ID-TEST] Prepare-mint successful');
    console.log('ğŸ“‹ [IP-ID-TEST] Has metadata:', !!result.metadata);
    console.log('ğŸ“‹ [IP-ID-TEST] Has transaction:', !!result.transaction);
    
    return result;
    
  } catch (error) {
    console.error('âŒ [IP-ID-TEST] Prepare-mint failed:', error.message);
    throw error;
  }
}

async function testExecuteStoryMintIpId(metadata) {
  console.log('\nğŸš€ [IP-ID-TEST] Testing execute-story-mint IP ID generation...');
  
  try {
    const response = await fetch(`${BASE_URL}/api/execute-story-mint`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userAddress: TEST_USER_ADDRESS,
        metadata: metadata
      }),
    });
    
    const result = await response.json();
    
    if (!response.ok || !result.success) {
      throw new Error(`Execute-story-mint failed: ${JSON.stringify(result.error)}`);
    }
    
    console.log('âœ… [IP-ID-TEST] Execute-story-mint successful');
    console.log('ğŸ“‹ [IP-ID-TEST] Has transaction:', !!result.transaction);
    console.log('ğŸ“‹ [IP-ID-TEST] Fallback mode:', !!result.fallbackMode);
    console.log('ğŸ“‹ [IP-ID-TEST] IP ID provided:', !!result.ipId);
    
    if (result.ipId) {
      const isValid = validateIpId(result.ipId, 'Execute-story-mint IP ID');
      if (!isValid) {
        throw new Error('Invalid IP ID generated by execute-story-mint');
      }
    } else {
      console.warn('âš ï¸ [IP-ID-TEST] No IP ID in execute-story-mint response');
    }
    
    return result;
    
  } catch (error) {
    console.error('âŒ [IP-ID-TEST] Execute-story-mint failed:', error.message);
    throw error;
  }
}

async function runIpIdTests() {
  console.log('ğŸš€ [IP-ID-TEST] Starting IP ID Generation Tests');
  console.log('ğŸš€ [IP-ID-TEST] =====================================\n');
  
  try {
    // Test 1: Prepare-mint
    const prepareMintResult = await testPrepareMintIpId();
    
    // Test 2: Execute-story-mint with success mode
    if (prepareMintResult.metadata) {
      const executeResult = await testExecuteStoryMintIpId(prepareMintResult.metadata);
      
      // Test 3: Compare IP IDs if both provided
      if (executeResult.ipId) {
        console.log('\nğŸ” [IP-ID-TEST] IP ID Analysis:');
        console.log('ğŸ“‹ [IP-ID-TEST] Generated IP ID:', executeResult.ipId);
        
        if (executeResult.debug) {
          console.log('ğŸ“‹ [IP-ID-TEST] Token ID used:', executeResult.debug.tokenId);
          console.log('ğŸ“‹ [IP-ID-TEST] Contract address:', executeResult.debug.rpcUrl ? '0xc32A8a0FF3beDDDa58393d022aF433e78739FAbc' : 'N/A');
        }
        
        // Validate the final IP ID
        const isValidFinal = validateIpId(executeResult.ipId, 'Final IP ID');
        
        if (isValidFinal) {
          console.log('\nğŸ‰ [IP-ID-TEST] =====================================');
          console.log('ğŸ‰ [IP-ID-TEST] IP ID Generation Tests - SUCCESS');
          console.log('ğŸ‰ [IP-ID-TEST] Valid Story Protocol IP ID generated');
          console.log('ğŸ‰ [IP-ID-TEST] =====================================');
        } else {
          throw new Error('Final IP ID validation failed');
        }
      } else {
        throw new Error('No IP ID generated by execute-story-mint');
      }
    } else {
      throw new Error('No metadata from prepare-mint to test execute-story-mint');
    }
    
  } catch (error) {
    console.error('\nğŸ’¥ [IP-ID-TEST] =====================================');
    console.error('ğŸ’¥ [IP-ID-TEST] IP ID Generation Tests - FAILED');
    console.error('ğŸ’¥ [IP-ID-TEST] Error:', error.message);
    console.error('ğŸ’¥ [IP-ID-TEST] =====================================');
    process.exit(1);
  }
}

// Run the test
if (require.main === module) {
  runIpIdTests();
}

module.exports = { runIpIdTests, validateIpId };