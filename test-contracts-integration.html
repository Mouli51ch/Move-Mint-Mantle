<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashflow Protocol Integration Test</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üöÄ Cashflow Protocol Integration Test</h1>
    <p>Test all deployed contracts on Mantle Sepolia Testnet</p>

    <div class="container info">
        <h3>üìã Contract Addresses</h3>
        <ul>
            <li><strong>SimpleCashflowProtocol:</strong> 0x54Fb33115B4b39A40A7267aEB69d2aBBA103Be1c</li>
            <li><strong>RevenueOracle:</strong> 0x4Ba705320F4c048BC89C8761d33e0Fbba9E659D8</li>
            <li><strong>CashflowToken:</strong> 0xBf994E5Ad6EDcF29F528D9d7c489e260Af6fBDC7</li>
            <li><strong>DistributionEngine:</strong> 0x94C32DF077BdF0053D39E70B8A4044e2403b7400</li>
        </ul>
    </div>

    <div class="container">
        <h3>üîó Wallet Connection</h3>
        <button onclick="connectWallet()">Connect Wallet</button>
        <div id="walletStatus">Not connected</div>
    </div>

    <div class="grid">
        <div class="container">
            <h3>üèõÔ∏è SimpleCashflowProtocol Tests</h3>
            <button onclick="testProtocolInfo()">Get Protocol Info</button>
            <button onclick="testRegisterStream()">Register Test Stream</button>
            <div id="protocolResults"></div>
        </div>

        <div class="container">
            <h3>üìä RevenueOracle Tests</h3>
            <button onclick="testSupportedPlatforms()">Get Supported Platforms</button>
            <button onclick="testOracleInfo()">Get Oracle Info</button>
            <div id="oracleResults"></div>
        </div>

        <div class="container">
            <h3>ü™ô CashflowToken Tests</h3>
            <button onclick="testTokenInfo()">Get Token Info</button>
            <button onclick="testTokenBalance()">Check Balance</button>
            <div id="tokenResults"></div>
        </div>

        <div class="container">
            <h3>üí∏ DistributionEngine Tests</h3>
            <button onclick="testDistributionFee()">Get Protocol Fee</button>
            <button onclick="testDistributionDue()">Check Distribution Due</button>
            <div id="distributionResults"></div>
        </div>
    </div>

    <div class="container">
        <h3>üîÑ End-to-End Test</h3>
        <p>Test complete cashflow stream creation and management:</p>
        <div>
            <input type="text" id="streamTitle" placeholder="Stream Title" value="Test Dance Stream">
            <input type="number" id="monthlyRevenue" placeholder="Monthly Revenue (MNT)" value="1" step="0.01">
            <input type="number" id="duration" placeholder="Duration (months)" value="12">
            <button onclick="runEndToEndTest()">Run Complete Test</button>
        </div>
        <div id="e2eResults"></div>
    </div>

    <script>
        let provider, signer, contracts = {};
        
        const CONTRACT_ADDRESSES = {
            SIMPLE_CASHFLOW_PROTOCOL: '0x54Fb33115B4b39A40A7267aEB69d2aBBA103Be1c',
            REVENUE_ORACLE: '0x4Ba705320F4c048BC89C8761d33e0Fbba9E659D8',
            CASHFLOW_TOKEN: '0xBf994E5Ad6EDcF29F528D9d7c489e260Af6fBDC7',
            DISTRIBUTION_ENGINE: '0x94C32DF077BdF0053D39E70B8A4044e2403b7400'
        };

        const ABIS = {
            SIMPLE_CASHFLOW_PROTOCOL: [
                'function registerStream(string memory title, uint256 projectedMonthlyRevenue, uint256 durationMonths) external returns (uint256)',
                'function getStreamInfo(uint256 streamId) external view returns (tuple(address creator, string title, uint256 projectedMonthlyRevenue, uint256 durationMonths, address tokenAddress, uint256 totalInvestment, bool isActive, bool isTokenized))',
                'function protocolFee() external view returns (uint256)',
                'function minimumInvestment() external view returns (uint256)'
            ],
            REVENUE_ORACLE: [
                'function getSupportedPlatforms() external view returns (string[])',
                'function getOracleInfo(address oracle) external view returns (tuple(address oracleAddress, uint256 reputation, uint256 totalSubmissions, uint256 successfulSubmissions, uint256 slashCount, bool isActive, uint256 registeredAt))'
            ],
            CASHFLOW_TOKEN: [
                'function name() external view returns (string)',
                'function symbol() external view returns (string)',
                'function totalSupply() external view returns (uint256)',
                'function balanceOf(address account) external view returns (uint256)'
            ],
            DISTRIBUTION_ENGINE: [
                'function protocolFeeRate() external view returns (uint256)',
                'function isDistributionDue(uint256 streamId, uint256 period) external view returns (bool)'
            ]
        };

        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    const address = await signer.getAddress();
                    const network = await provider.getNetwork();
                    
                    document.getElementById('walletStatus').innerHTML = `
                        <div class="success">
                            ‚úÖ Connected: ${address}<br>
                            üåê Network: ${network.name} (${network.chainId})
                        </div>
                    `;

                    // Initialize contracts
                    contracts.protocol = new ethers.Contract(CONTRACT_ADDRESSES.SIMPLE_CASHFLOW_PROTOCOL, ABIS.SIMPLE_CASHFLOW_PROTOCOL, signer);
                    contracts.oracle = new ethers.Contract(CONTRACT_ADDRESSES.REVENUE_ORACLE, ABIS.REVENUE_ORACLE, provider);
                    contracts.token = new ethers.Contract(CONTRACT_ADDRESSES.CASHFLOW_TOKEN, ABIS.CASHFLOW_TOKEN, provider);
                    contracts.distribution = new ethers.Contract(CONTRACT_ADDRESSES.DISTRIBUTION_ENGINE, ABIS.DISTRIBUTION_ENGINE, provider);
                    
                } else {
                    document.getElementById('walletStatus').innerHTML = '<div class="error">‚ùå MetaMask not found</div>';
                }
            } catch (error) {
                document.getElementById('walletStatus').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testProtocolInfo() {
            try {
                const protocolFee = await contracts.protocol.protocolFee();
                const minimumInvestment = await contracts.protocol.minimumInvestment();
                
                document.getElementById('protocolResults').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Protocol Info Retrieved</h4>
                        <p><strong>Protocol Fee:</strong> ${protocolFee.toString()} basis points (${protocolFee/100}%)</p>
                        <p><strong>Minimum Investment:</strong> ${ethers.utils.formatEther(minimumInvestment)} MNT</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('protocolResults').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testRegisterStream() {
            try {
                const title = "Test Stream " + Date.now();
                const monthlyRevenue = ethers.utils.parseEther("1.0");
                const duration = 12;
                
                const tx = await contracts.protocol.registerStream(title, monthlyRevenue, duration);
                const receipt = await tx.wait();
                
                document.getElementById('protocolResults').innerHTML += `
                    <div class="success">
                        <h4>‚úÖ Stream Registered</h4>
                        <p><strong>Transaction:</strong> ${receipt.transactionHash}</p>
                        <p><strong>Title:</strong> ${title}</p>
                        <p><strong>Monthly Revenue:</strong> 1.0 MNT</p>
                        <p><strong>Duration:</strong> ${duration} months</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('protocolResults').innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testSupportedPlatforms() {
            try {
                const platforms = await contracts.oracle.getSupportedPlatforms();
                
                document.getElementById('oracleResults').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Supported Platforms</h4>
                        <ul>${platforms.map(p => `<li>${p}</li>`).join('')}</ul>
                    </div>
                `;
            } catch (error) {
                document.getElementById('oracleResults').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testOracleInfo() {
            try {
                const address = await signer.getAddress();
                const info = await contracts.oracle.getOracleInfo(address);
                
                document.getElementById('oracleResults').innerHTML += `
                    <div class="info">
                        <h4>üìä Oracle Info for ${address}</h4>
                        <p><strong>Reputation:</strong> ${info.reputation.toString()}/10000</p>
                        <p><strong>Total Submissions:</strong> ${info.totalSubmissions.toString()}</p>
                        <p><strong>Is Active:</strong> ${info.isActive ? 'Yes' : 'No'}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('oracleResults').innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testTokenInfo() {
            try {
                const name = await contracts.token.name();
                const symbol = await contracts.token.symbol();
                const totalSupply = await contracts.token.totalSupply();
                
                document.getElementById('tokenResults').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Token Info</h4>
                        <p><strong>Name:</strong> ${name}</p>
                        <p><strong>Symbol:</strong> ${symbol}</p>
                        <p><strong>Total Supply:</strong> ${ethers.utils.formatEther(totalSupply)} tokens</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('tokenResults').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testTokenBalance() {
            try {
                const address = await signer.getAddress();
                const balance = await contracts.token.balanceOf(address);
                
                document.getElementById('tokenResults').innerHTML += `
                    <div class="info">
                        <h4>üí∞ Your Token Balance</h4>
                        <p><strong>Address:</strong> ${address}</p>
                        <p><strong>Balance:</strong> ${ethers.utils.formatEther(balance)} tokens</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('tokenResults').innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testDistributionFee() {
            try {
                const feeRate = await contracts.distribution.protocolFeeRate();
                
                document.getElementById('distributionResults').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Distribution Engine Info</h4>
                        <p><strong>Protocol Fee Rate:</strong> ${feeRate.toString()} basis points (${feeRate/100}%)</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('distributionResults').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testDistributionDue() {
            try {
                const isDue = await contracts.distribution.isDistributionDue(1, 1);
                
                document.getElementById('distributionResults').innerHTML += `
                    <div class="info">
                        <h4>üìÖ Distribution Status</h4>
                        <p><strong>Stream ID 1, Period 1:</strong> ${isDue ? 'Distribution Due' : 'No Distribution Due'}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('distributionResults').innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function runEndToEndTest() {
            const resultsDiv = document.getElementById('e2eResults');
            resultsDiv.innerHTML = '<div class="info">üîÑ Running end-to-end test...</div>';
            
            try {
                const title = document.getElementById('streamTitle').value;
                const monthlyRevenue = document.getElementById('monthlyRevenue').value;
                const duration = parseInt(document.getElementById('duration').value);
                
                // Step 1: Register stream
                resultsDiv.innerHTML += '<div class="info">Step 1: Registering cashflow stream...</div>';
                const monthlyRevenueWei = ethers.utils.parseEther(monthlyRevenue);
                const tx = await contracts.protocol.registerStream(title, monthlyRevenueWei, duration);
                const receipt = await tx.wait();
                
                // Extract stream ID from events (simplified)
                const streamId = 1; // In a real implementation, you'd parse the event logs
                
                resultsDiv.innerHTML += `<div class="success">‚úÖ Stream registered! TX: ${receipt.transactionHash}</div>`;
                
                // Step 2: Get stream info
                resultsDiv.innerHTML += '<div class="info">Step 2: Retrieving stream information...</div>';
                const streamInfo = await contracts.protocol.getStreamInfo(streamId);
                
                resultsDiv.innerHTML += `
                    <div class="success">
                        <h4>‚úÖ End-to-End Test Complete!</h4>
                        <p><strong>Stream ID:</strong> ${streamId}</p>
                        <p><strong>Creator:</strong> ${streamInfo.creator}</p>
                        <p><strong>Title:</strong> ${streamInfo.title}</p>
                        <p><strong>Monthly Revenue:</strong> ${ethers.utils.formatEther(streamInfo.projectedMonthlyRevenue)} MNT</p>
                        <p><strong>Duration:</strong> ${streamInfo.durationMonths.toString()} months</p>
                        <p><strong>Is Active:</strong> ${streamInfo.isActive ? 'Yes' : 'No'}</p>
                        <p><strong>Is Tokenized:</strong> ${streamInfo.isTokenized ? 'Yes' : 'No'}</p>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">‚ùå End-to-end test failed: ${error.message}</div>`;
            }
        }

        // Auto-connect on page load
        window.addEventListener('load', () => {
            if (typeof window.ethereum !== 'undefined') {
                connectWallet();
            }
        });
    </script>
</body>
</html>